Load/Store Unit
===============



Store Address Instruction
-------------------------

- **A**\llocated
- **val**\id address
- **addr**\ess
- **V**\irtual address
- **D**\ata availability
- **tag**


Інструкція в модуль може прийти в трьох станах

1. адреса і дані
2. адреса
3. дані

Може відбутися так події:

- Промах TLB;
- Відсутність даних;
- Вбивство.

При першій ситуації в модуль прибуває повна інструкція з черги.
В модулі обраховується віртуальна адреса після чого відбувається
звернення в TLB для визначення фізичної адреси.
Відбувається запис в SAQ та кеш.
Наступного такту відбувається пошук на збіг вхідної адреси з адресами SAQ для
визначення адреси комірки в яку відбувся запис яка потрібно для запису
даних в наступні стадії.

Ситуації два. В модуль прибуває інструкція з черги лише з першим
виконаним залежним регістром. В модулі обраховується віртуальна адреса після
чого відбувається звернення в TLB для визначення фізичної адреси.
Після чого записується в таблицю SAQ.

Ситуація три. Дана ситуація формується якщо в даний модуль вже була відправлена
адреса. В модуль прибуває інструкція з черги лише з другим залежним регістром.
На це вказує відповідні біти.
Обраховується віртуальна адреса після чого відбувається звернення в TLB.
Дана ситуація не потребує виділенні нової комірки в SAQ оскільки запис вже
існує.
Наступного такту відбувається пошук на збіг вхідної адреси з адресами SAQ для
визначення адреси комірки в яку відбувся запис яка потрібно для запису
даних в наступні стадії.

Відсутність збігу адрес відбувається через оновлення TLB.
Оскільки віртуальні адреси в таблиці не встигли виконатися.
В даній ситуації зупиняється конвеєр і відбувається повторне звернення в TLB
для віртуальних адрес в таблиці SAQ поки не відбудеться збіг.
Після чого відбувається відновлення роботи.

В не залежності від ситуацій потрібно зберігати маску по які відбудеться
вбивство інструкції якщо в цьому є необхідність.

Store Data Instruction
----------------------

Дані інструкцій завантаження зберігаються окремо в модулі пам'яті з асинхронним
входом читання.

Load Instruction
----------------

Інструкція потрапляє в модуль. Обраховується адреса і записується
в чергу SAQ(Load Address Queue).

- **A**\llocated
- **val**\id address
- **addr**\ess
- **V**\irtual address
- a match in the **S**\AQ
- cache **M**\iss
- **rd** (destination register)
- **tag**

Виконана інструкція може видалитися з черги LAQ.
Нижче наведені причини затримки через які інструкція вважається не виконаною.

- Промах TLB;
- Збіг в черзі SAQ(Store Address Queue), але відсутні дані;
- Промах кешу;
- Вбивство.

При промаху в модулі TLB в чергу відправляємо віртуальну адресу та
встановлюємо відповідний прапор. Інструкція повторно прокинеться для
того, щоб визначити фізичну адресу.

При збігу адреси в SAQ і відсутності даних.
При повторному надходженні інструкції збереження в модуль.
Віб

При промаху кешу інструкція залишається в черзі для повторного виконання її.
Через затримку надходження сигнал промаху кешy не дозволяє наперед відправити
сигнал в черги.
Що не дає змогу прибрати затримку внаслідок оминання регістрового файлу.

Якщо в модуль приходить сигнал вбивства інструкцій за маскою гілок через не
коректно визначену адресу при передбаченні гілки.
Інструкція не видаляється з черги оскільки залишається висока ймовірність
звернення за даною адресою в близькому майбутньому.
Інструкція виконується для того, щоб поновити кеш.

Проблема
--------

.. code-block:: 

   add s2,??,?? #s2=3
   add s1,??,?? #s1=2
   add a1,??,??
   add a2,??,??
   ...
   addi s1,s1,1
   sw  a1,0(s1) #s1==s2
   lw  a3,0(s1)
   sw  a2,0(s2)
   lw  a4,0(s2)
   ...

